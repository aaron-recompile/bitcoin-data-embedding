# Chapter 3

## 彩色币（Colored Coins）——第一次"隐式编码"尝试

### 比特币资产协议的开端

---

## 3.1 起源：能不能在比特币上发行资产？

2012 年，比特币已经运行了三年。一些开发者开始思考：

**能否在不改变比特币协议的前提下，在比特币上发行其他资产？**

这个想法的动机很简单：
- 比特币的安全性和去中心化已经被验证
- 但 BTC 本身只能表示"比特币"这一种价值
- 如果能让 UTXO 承载更多含义，就能在比特币上构建更丰富的应用

2012 年，Meni Rosenfeld 发布了《Colored Coins》白皮书，提出了一个激进的想法：

**给某些 UTXO "染色"，让它们代表链外资产。**

这就是彩色币（Colored Coins）的诞生。

---

## 3.2 EPOBC：零开销的大胆实验

### 3.2.1 核心思想

EPOBC（Enhanced Padded-Order-Based Coloring）是最早的彩色币实现之一。它的设计哲学极其激进：

**能否在完全不增加链上数据的前提下，实现资产协议？**

答案是：**技术上可以，但实际上不行。**

### 3.2.2 nSequence 字段的妙用

每个比特币交易输入都有一个 4 字节的 `nSequence` 字段，原本用于交易替换。EPOBC 的创新：

**用 nSequence 的低 6 位来标记交易类型**

```
第一个输入的 nSequence & 0x3F:
  0x25 (37) → Genesis 交易（发行资产）
  0x33 (51) → Transfer 交易（转移资产）
  其他     → 普通比特币交易
```

**Genesis 交易（发行）：**
- 检测到 nSequence = 0x25
- 第一个输出即为"彩色币"
- 资产数量 = 输出的 satoshi 数量
- Color ID = "txid:vout"

**Transfer 交易（转账）：**
- 检测到 nSequence = 0x33
- 收集所有彩色输入
- 按输出顺序分配颜色（order-based）

### 3.2.3 零开销的代价

**看似完美的设计：**
- ✅ 真正的零字节开销
- ✅ 不污染 UTXO 集
- ✅ 对矿工完全透明

**致命缺陷：**
- ❌ 资产数量 = satoshi 数量（强制耦合）
- ❌ 完全隐式，钱包不兼容会破坏颜色
- ❌ 依赖输出顺序，极其脆弱
- ❌ 无法附加元数据

---

## 3.3 为什么彩色币失败：脆弱性分析

### 3.3.1 钱包破坏颜色

**场景 1：不兼容钱包**

```
用户 Alice 持有 1000 个彩色币（在一个 UTXO 中）

Alice 用普通比特币钱包发起转账：
  → 钱包自动选择包含彩色币的 UTXO
  → 钱包不知道需要保持 nSequence = 0x33
  → 创建找零时 nSequence 被重置为 0xFFFFFFFF
  
结果：
  ✗ 彩色币标记完全丢失
  ✗ 1000 个资产单位永久变回普通 BTC
  ✗ 用户甚至不知道发生了什么
```

**场景 2：UTXO 合并混淆**

```
Alice 有两个 UTXO：
  UTXO_A: 500 units of Asset_X
  UTXO_B: 300 units of Asset_Y（不同资产！）

普通钱包合并创建单笔转账：
  Input: [UTXO_A, UTXO_B]
  Output: 一个地址
  
问题：
  - 800 units of Asset_X？
  - 500 units of Asset_X + 300 units of Asset_Y？
  - Order-based coloring 无法处理混合资产
  
结果：颜色混淆，资产丢失
```

**场景 3：输出重排序**

```
交易原本：
  Output[0]: Alice 地址 → 应得 300 units
  Output[1]: Bob 地址 → 应得 700 units

如果钱包优化手续费，重新排序输出：
  Output[0]: Bob 地址
  Output[1]: Alice 地址
  
Order-based coloring 的映射：
  Output[0] → 300 units (现在给了 Bob！)
  Output[1] → 700 units (现在给了 Alice！)
  
结果：资产分配完全错误
```

### 3.3.2 Dust Limit 的经济问题

Bitcoin Core 引入 dust limit（最小输出限制）：

```
历史演变：
  早期（~2014）: 5460 satoshis
  后来（~2015+）: 546 satoshis
  SegWit 时代: 294 satoshis
```

**对 EPOBC 的致命打击：**

由于资产数量 = satoshi 数量：

```
发行 1,000,000 个资产单位：

理论成本：1,000,000 sats = 0.01 BTC
实际成本：546,000,000 sats = 5.46 BTC

如果 BTC = $100,000
实际美元成本 = $546,000

成本放大：546 倍
```

这让 EPOBC 在经济上完全不可行。

### 3.3.3 根本原因

彩色币失败的核心原因：

1. **缺乏强制执行**
   - 比特币共识层不验证"颜色"
   - 任何破坏颜色的交易都是合法的
   - 无法阻止误操作

2. **隐式标记太脆弱**
   - nSequence 字段可以被任意修改
   - 没有密码学保护
   - 完全依赖链外解释的一致性

3. **生态不兼容**
   - 必须使用专门钱包
   - 一旦误用普通钱包 → 永久丢失
   - 无法形成网络效应

**结论：在开放、不可信的网络中，完全隐式的协议注定失败。**

---

## 3.4 Open Assets：引入 OP_RETURN

### 3.4.1 显式标记的尝试

2013 年末，Bitcoin Core 0.9.0 引入了 `OP_RETURN`，允许嵌入最多 40 字节数据（后来 80 字节）。

Open Assets Protocol 立即采用，创建 "Marker Output"：

```
OP_RETURN 数据：
  0x6a           ← OP_RETURN opcode
  0x4f 0x41      ← "OA" 标识
  <version>      ← 版本号
  <quantities>   ← 资产数量列表（可变长度编码）
  <metadata>     ← 可选元数据
```

**关键改进：**
- ✅ 资产数量与 BTC 金额解耦
- ✅ 明确的协议标识符
- ✅ 支持元数据

### 3.4.2 仍然失败

Open Assets 虽然有改进，但仍然失败：

- ❌ 仍然依赖 order-based coloring（输出顺序）
- ❌ 钱包仍需特殊支持
- ❌ 无法混合不同资产
- ❌ 缺乏密码学承诺

**一句话总结：** Open Assets 引入了 OP_RETURN 的正确方向，但协议设计仍不够成熟。

---

## 3.5 彩色币的历史贡献

彩色币虽然失败了，但它是整个比特币资产协议历史的开端。

### 3.5.1 证明了可行性

**彩色币证明：**
- ✅ UTXO 模型**可以**承载资产语义
- ✅ 链外状态机**可以**工作
- ✅ OP_RETURN **可以**成为数据容器

### 3.5.2 暴露了问题

**彩色币暴露：**
- ❌ 完全隐式的协议不可靠
- ❌ Order-based coloring 太脆弱
- ❌ 必须有明确的链上标记
- ❌ 需要密码学保护

### 3.5.3 启发了后续协议

**直接启发：**

1. **Omni Layer（2013-2014）**
   - 成熟的 OP_RETURN 规范
   - 完整的指令集
   - USDT 的诞生地
   - **→ 第 4 章的主题**

2. **Counterparty（2014）**
   - 多种数据编码方式
   - 去中心化交易所
   - 智能合约支持

**长远启发：**

3. **RGB Protocol（2019+）**
   - 完善的客户端验证
   - Taproot 承诺
   - 继承彩色币的"链外状态"思想
   - 但加入了密码学保护

4. **Taproot Assets（2023+）**
   - 基于 Taproot 的资产协议
   - 仍然是"UTXO 承载资产"的思路

### 3.5.4 推动了 OP_RETURN 标准化

```
时间线：
  2012 → 彩色币提出，缺乏标准数据嵌入方式
  2013 → OP_RETURN 讨论，彩色币是主要推动力
  2014 → Bitcoin Core 0.9 引入 OP_RETURN (40 bytes)
  2016 → 扩展到 80 bytes
  2025 → 扩展到 100,000 bytes (v30)
```

没有彩色币对数据嵌入的探索，OP_RETURN 可能不会这么快被标准化。

---

## 3.6 小结：第一次尝试的意义

**彩色币告诉我们：**

✅ **技术可行性**
- 比特币 UTXO 可以承载资产
- 链外状态机可以工作
- 不需要改变共识规则

❌ **实践困境**
- 隐式协议太脆弱
- 钱包生态不兼容
- 缺乏强制执行机制
- 经济成本过高

**历史定位：**

彩色币是比特币资产协议的"概念验证"（Proof of Concept）：
- 它证明了方向是对的
- 但也暴露了必须解决的问题
- 为后续协议铺平了道路

**演进路径：**

```
彩色币（2012-2014）：隐式编码，概念验证
     ↓
Omni（2014-now）：显式 OP_RETURN，生产级协议
     ↓
现代协议：密码学承诺 + 完善的状态机
```

---

## 3.7 承上启下：为什么需要 Omni

彩色币的失败暴露了一个核心问题：

**如何在保持比特币去中心化的前提下，构建可靠的资产协议？**

答案的关键：**明确的链上数据 + 成熟的协议规范**

2013 年末，就在彩色币探索的同时，另一个团队在开发更雄心勃勃的项目：

**Mastercoin**（后改名 Omni Layer）

**Omni 的设计思路：**
- 完整的 OP_RETURN 数据协议
- 结构化的指令集
- 确定性的状态机
- 明确的版本控制

**关键突破：**
- 不只是"资产数量"，而是完整的交易类型系统
- 不只是"标记"，而是可验证的数据结构
- 不只是"概念验证"，而是生产级系统

**历史验证：**

2014 年，USDT 选择在 Omni 上发行。至今仍有数十亿美元的 USDT 在 Omni 上运行。

这证明了从彩色币到 Omni 的演进是成功的。

---

**下一章预告：**

**第 4 章：Omni Layer（Mastercoin）—— 第一个生产级协议**

我们将看到：
- OP_RETURN 的成熟规范
- USDT 的诞生故事  
- 从实验到生产的跨越
- 显式数据编码如何解决彩色币的问题

---

**💡 动手实践：**

想要深入理解彩色币的脆弱性？参考 **Chapter 3 Part 2: 动手实践**，我们将用最简单的代码复现：
- nSequence 标记机制
- Order-based coloring 算法
- 为什么钱包会破坏颜色
- 攻击场景的实际演示

**目标：** 通过代码理解"为什么彩色币必然失败"。